<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="robot" content="index, follow">
        <meta name="og:site_name" content="@JochLAin on Github">
        <meta name="og:title" content="Blog de Jocelyn Faihy">
        <title>Blog de Jocelyn Faihy</title>
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-42074651-4"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){ dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'UA-42074651-4');
        </script>
    </head>
    <body id="blog" class="bg-light" data-spy="scroll" data-target="#navbar-example2" data-offset="0">
        <header>
            <a id="homepage" href="/" class="text-dark">
                <h1>
                    <b class="mx-2">Jocelyn</b>
                    <span class="fas fa-rocket fa-fw fa-2x"></span>
                    <b class="mx-2">Faihy</b>
                </h1>
            </a>
            <a href="/blog.html">
                <aside class="separator"></aside>
            </a>
        </header>
        <article class="blog container">
            <nav class="navigation navigation--dark">
                <section class="navigation__item active">
                    <a href="/blog/envoi-de-fichier-1.html" class="navigation__link">
                        <span class="navigation__label mr-2">L'envoi de fichier</span>
                        <span class="fas fa-circle"></span>
                    </a>
                </section>
                <section class="navigation__item">
                    <a href="/blog/envoi-de-fichier-2.html" class="navigation__link">
                        <span class="navigation__label mr-2">L'affichage</span>
                        <span class="far fa-circle"></span>
                    </a>
                </section>
                <section class="navigation__item">
                    <a href="/blog/envoi-de-fichier-3.html" class="navigation__link">
                        <span class="navigation__label mr-2">La gestion en BDD</span>
                        <span class="far fa-circle"></span>
                    </a>
                </section>
                <section class="navigation__item">
                    <a href="/blog/envoi-de-fichier-4.html" class="navigation__link">
                        <span class="navigation__label mr-2">Le champs de formulaire</span>
                        <span class="far fa-circle"></span>
                    </a>
                </section>
            </nav>
            <article class="blog__article">
                <h2>L'envoi de fichier (1/4)</h2>
                <p>
                    Dans cette partie nous allons gérer l'envoi sur le serveur du(des) fichier(s).
                </p>
                <hr />
                <p>
                    Jusqu'à il y a peu, j'utilisais une bibliothèque qui gère déjà très bien l'envoi de fichier : <a href="https://www.dropzonejs.com/" target="_blank">Dropzone</a>.<br />
                    Mais après l'avoir mis à jour j'ai eu une erreur et impossible de la réparer sans aller trifouiller les fichiers sources <i>(depuis l'erreur a été corrigée)</i>.<br />
                    Les clients attendant une mise à jour de leur site, je n'ai pas pu attendre leur correction et j'ai dû coder un <strong>uploader</strong>.<br />
                    Nous allons voir ensemble comment j'ai procéder.
                </p>
                <p>
                    Tout d'abord, j'ai initialisé une classe avec les propriétés suivantes :
                    <ul>
                        <li>
                            <b class="text-dark">url</b>: sur quelle URL le fichier doit être envoyé
                        </li>
                        <li>
                            <a href="https://developer.mozilla.org/fr/docs/Web/HTML/Element/input#attr-multiple" target="_blank">multiple</a>:
                            détermine si plusieurs fichiers peuvent être envoyés au serveur
                        </li>
                        <li>
                            <b class="text-dark">chunk</b>: détermine si le tronçonnage de fichier doit être utilisé
                        </li>
                        <li>
                            <b class="text-dark">chunk_size</b>: détermine la taille d'un tronçon <i>(en octet)</i>
                        </li>
                        <li>
                            <a href="https://developer.mozilla.org/fr/docs/Web/HTML/Element/Input/file" target="_blank">input</a>: l'input de type file sur lequel les fichiers sont assignés
                        </li>
                        <li>
                            <b class="text-dark">onSuccess</b>: fonction appelé lors de la réussite de l'envoi
                        </li>
                        <li>
                            <b class="text-dark">onRemove</b>: fonction appelé lors de la suppression d'un fichier<br />
                            Par exemple quand on doit supprimer le fichier sur le serveur.
                        </li>
                    </ul>
                </p>
                <pre class="blog__article__code"><!--
                --><aside class="blog__article__code--filename">assets/manager/uploader.jsx</aside><!--
                --><code class="blog__article__code--content jsx"><!--
-->import uuid from 'uuid';

export default class UploaderManager {
    constructor(props) {
        this.props = props;

        // Vérifie que la propriété obligatoire est bien présente
        if (!this.props.url) {
            throw new Error('La propriétés "url" est manquante');
        }

        // Permet d'initialiser le manager à partir d'un input
        if (this.props.input && this.props.input.getAttribute('type') == 'file') {
            this.props.multiple = this.props.input.getAttribute('multiple');
            this.props.input.addEventListener('change', () => {
                this.upload(this.props.input);
            });
        }
    }
}<!--
                --></code><!--
            --></pre>
                <p>
                    Ensuite on va créer une méthode pour envoyer des données au serveur.
                </p>
                <pre class="blog__article__code"><!--
                --><aside class="blog__article__code--filename">assets/manager/uploader.jsx</aside><!--
                --><code class="blog__article__code--content jsx"><!--
-->// ...

export default class UploaderManager {
    // ...

    // Création et envoie de la requête
    send = (data) => {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', this.props.url, true);
            // listener appelé lors de la réponse à la requête
            xhr.addEventListener('load', () => {
                const response = xhr.getResponseHeader('Content-Type') == 'application/json'
                    ? JSON.parse(xhr.responseText)
                    : xhr.responseText
                ;
                if (xhr.status < 200 && xhr.status >= 400) {
                    // En cas d'erreur
                    reject({ response, data, xhr });
                } else {
                    // En cas de réussite
                    resolve({ response, data, xhr });
                }
            });
            xhr.send(data);
        });
    }
}<!--
                --></code><!--
            --></pre>
                <p>
                    À partir d'ici, si vous n'êtes pas familier avec les <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Promise" target="_blank">Promise</a>, cela va devenir un peu plus complexe.<br />
                    Nous allons créer la méthode qui va formater les données à envoyer au serveur.
                </p>
                <pre class="blog__article__code"><!--
                --><aside class="blog__article__code--filename">assets/manager/uploader.jsx</aside><!--
                --><code class="blog__article__code--content jsx"><!--
-->// ...

export default class UploaderManager {
    // ...

    upload = (input) => {
        const promises = [];

        // Gestion des erreurs via l'attribut multiple
        if (!this.props.multiple && input.files.length > 1) {
            toastr.error("Plus d'un fichier est envoyé au serveur.");
            return;
        }

        // Closure qui permet de formatter les données en entrée, en donnée de formulaire
        // C'est bien plus simple à envoyer au serveur
        const _upload = (file) => {
            const data = new FormData();
            data.append('file', file);
            return this.send(data);
        }

        let promise = null;
        // Si il y a plusieurs fichiers on renverra un promise une fois que tous les fichiers seront envoyés 
        if (this.props.multiple) {
            for (let index = 0; index < input.files.length; index++) {
                const file = input.files[index];
                promises.push(_upload(file));
            }
            // Renvoie une promise qui est résolue lorsque toutes les promises sont résolues
            promise = Promise.all(promises);
        } else {
            // On upload que le premier fichier
            promise = _upload(input.files[0]);
        }

        // Appel des callbacks
        if (this.props.onSuccess) {
            promise.then((uploads) => {
                if (this.props.multiple) {
                    this.props.onSuccess(uploads.map(upload => upload.response));
                } else {
                    this.props.onSuccess(uploads.response);
                }
            }, this.props.onError);
        }

        // On renvoie une promise traitée dans le cas d'une erreur
        if (this.props.onError) {
            promise.catch(this.props.onError)
        }
        return promise;
    }
}<!--
                --></code><!--
            --></pre>
                <p>
                    Avec ceci, j'ai maintenant tous les outils en main pour envoyer des fichiers du navigateur à mon serveur.<br />
                    Voici une liste de quelques configurations possibles.
                </p>
                <pre class="blog__article__code"><!--
                --><aside class="blog__article__code--filename">templates/index.html</aside><!--
                --><code class="blog__article__code--content html"><!--
-->&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
    &lt;head&gt;
        &lt;title&gt;Test uploader&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;input type="file" id="input-file-single"&gt;
        &lt;input type="file" id="input-file-multiple" multiple&gt;
        &lt;script type="text/javascript" src="path/to/script.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            document.addEventListener('load', function () {
                // Envoi simple
                var manager_single_simple = new UploadManager({
                    input: document.getElementById('input-file-single'),
                    url: '/upload/',
                });

                // Envoi multiple
                var manager_multiple_simple = new UploadManager({
                    input: document.getElementById('input-file-multiple'),
                    url: '/upload/',
                    onSuccess: function () {
                        console.log('Le tranfert est terminé avec succès');
                    },
                    onError: function () {
                        console.log('Le tranfert est terminé avec une erreur');
                    }
                });
            });
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;<!--
                --></code><!--
            --></pre>
                <h3>Tronçonnage des fichiers</h3>
                <p>
                    Pour des raisons de limitation serveur, j'ai dû ajouter la fonctionnalité du <a href="https://en.wikipedia.org/wiki/Chunk_(information)" target="_blank">chunk</a>.<br />
                    Pour cela, j'ai un peu modifié la closure <code>_upload</code> pour qu'elle gère le découpage en tronçon du fichier.<br />
                    J'ai aussi ajouté la méthode qui découpe le fichier, pour ça j'ai utilisé les classes <a href="https://developer.mozilla.org/fr/docs/Web/API/File" target="_blank">File</a> et <a href="https://developer.mozilla.org/fr/docs/Web/API/Blob" target="_blank">Blob</a> déjà existantes dans Javascript.
                </p>
                <pre class="blog__article__code"><!--
                --><aside class="blog__article__code--filename">assets/manager/uploader.jsx</aside><!--
                --><code class="blog__article__code--content jsx"><!--
-->// ...

export default class UploaderManager {
    // ...

    upload = (input) => {
        // ...

        const _upload = (file) => {
            // Si le découpage est configuré
            if (this.props.chunk && this.props.chunk_size > 0) {
                const id = uuid.v4().replace(/-/g, '');
                return this.chunk(file, id);
            }

            const data = new FormData();
            data.append('file', file);
            return this.send(data);
        }

        // ...
    }

    // Découpage du fichier pour ne pas excéder la limite de taille des données envoyées au serveur
    chunk = (file, id) => {
        // Calcul du nombre de découpage à créer
        const count = Math.ceil(file.size / this.props.chunk_size);
        const promises = [];

        // Découpage en petit paquet du fichier
        for (let index = 0; index < count; index++) {
            let start = index * this.props.chunk_size;
            let end = (index +1) * this.props.chunk_size;
            const data = new FormData();
            const blob = file.slice(start, end, file.type);
            const chunk = new File([blob], file.name, { type: file.type });

            // On ajoute ces informations pour que le serveur puissent gérer l'assemblage des différentes parties
            data.append('chunk_count', count);
            data.append('chunk_index', index);
            data.append('chunk_uuid', id);
            data.append('chunk', chunk);
            promises.push(this.send(data));
        }

        return Promise.all(promises).then(uploads => {
            return Object.assign({}, uploads[0], { response: uploads[0].response.file });
        });
    }
}<!--
                --></code><!--
            --></pre>
                <p>Et l'exemple d'intégration qui va avec :</p>
                <pre class="blog__article__code"><!--
                --><aside class="blog__article__code--filename">templates/index.html</aside><!--
                --><code class="blog__article__code--content html"><!--
-->&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
    &lt;head&gt;
        &lt;title&gt;Test uploader&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;input type="file" id="input-file-single"&gt;
        &lt;input type="file" id="input-file-multiple" multiple&gt;
        &lt;script type="text/javascript" src="path/to/script.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            document.addEventListener('load', function () {
                // Envoi avec tronçonnage
                var manager_single_chunk = new UploadManager({
                    input: document.getElementById('input-file-single'),
                    url: '/upload/',
                    chunk: true,
                    chunk_size: 1000000,
                });
            });
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;<!--
                --></code><!--
            --></pre>
                <p>
                    Dans la prochaine partie nous verrons comment améliorer l'affichage avec <a href="https://reactjs.org" target="_blank">React</a>
                </p>
                <footer class="d-flex align-items-center justify-content-around">
                    <article></article>
                    <a href="/blog/envoi-de-fichier-2.html">
                        <article class="d-flex align-items-center justify-content-center">
                            <section class="mx-1">
                                Partie 2 : Affichage
                            </section>
                            <section class="mx-1">
                                <span class="fas fa-arrow-right"></span>
                            </section>
                        </article>
                    </a>
                </footer>
            </article>
        </article>
        <footer class="bg-dark text-light text-center">
            <small>Jocelyn Faihy <sup><span class="far fa-copyright"></span></sup> - All rights reserved - 2018</small>
        </footer>
        <script type="text/javascript" src="/js/style.js"></script>
    </body>
</html>